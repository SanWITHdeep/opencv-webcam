<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Webcam Processing with OpenCV.js</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean look */
        body {
            font-family: 'Inter', sans-serif;
        }
        .video-container {
            position: relative;
            width: 100%;
            max-width: 720px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        #videoInput, #canvasOutput {
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
        }
        #canvasOutput {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Webcam Fun with OpenCV.js</h1>
        <p class="text-gray-600 mb-6">This page uses your webcam to apply a real-time Canny edge detection filter.</p>

        <!-- Status Message -->
        <div id="status" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6 shadow-md">
            <p>Loading OpenCV.js, please wait...</p>
        </div>

        <!-- Video and Canvas Container -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Stream -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Live Webcam Feed</h2>
                <div class="video-container bg-black">
                    <video id="videoInput" playsinline autoplay muted class="opacity-75"></video>
                </div>
            </div>
            <!-- Output Stream -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">OpenCV Processed Output</h2>
                 <div class="video-container bg-black">
                    <canvas id="canvasOutput"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- OpenCV.js Script -->
    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

    <script type="text/javascript">
        // Get DOM elements
        const video = document.getElementById('videoInput');
        const canvas = document.getElementById('canvasOutput');
        const statusElement = document.getElementById('status');
        const FPS = 30; // Target frames per second for processing

        function onOpenCvReady() {
            // Update status to show OpenCV is loaded
            statusElement.innerHTML = '<p>OpenCV.js is ready. Trying to access webcam...</p>';
            
            // Check for camera access
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false })
                    .then(function(stream) {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(err) {
                        console.error("An error occurred: " + err);
                        statusElement.innerHTML = `<p class="text-red-600">Error accessing webcam: ${err}. Please grant permission and refresh.</p>`;
                        statusElement.classList.remove('bg-blue-100', 'border-blue-500', 'text-blue-700');
                        statusElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                    });
            } else {
                console.error("getUserMedia not supported on your browser!");
                statusElement.innerHTML = '<p class="text-red-600">Your browser does not support webcam access.</p>';
                statusElement.classList.remove('bg-blue-100', 'border-blue-500', 'text-blue-700');
                statusElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            }

            // Listen for the video to be ready to play
            video.addEventListener('canplay', startVideoProcessing);
        }

        function startVideoProcessing() {
            // Ensure OpenCV is loaded before proceeding
            if (!window.cv || !window.cv.Mat) {
                console.log("OpenCV not ready yet, waiting...");
                setTimeout(startVideoProcessing, 100);
                return;
            }

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Update status
            statusElement.innerHTML = '<p class="text-green-600">Webcam active! Processing video...</p>';
            statusElement.classList.remove('bg-blue-100', 'border-blue-500', 'text-blue-700');
            statusElement.classList.add('bg-green-100', 'border-green-500', 'text-green-700');

            // --- Main OpenCV Processing Logic ---
            
            // Create OpenCV matrix objects
            // These are like canvases for OpenCV to work with
            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1); // Grayscale destination
            let gray = new cv.Mat();

            // Create a VideoCapture object to read frames from the video element
            let cap = new cv.VideoCapture(video);

            function processVideo() {
                try {
                    // Start processing time
                    let begin = Date.now();

                    // Read a frame from the video capture
                    cap.read(src);

                    // Convert the frame to grayscale
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                    // Apply Canny edge detection
                    // The numbers 50 and 100 are thresholds; you can play with these values
                    cv.Canny(gray, dst, 50, 100, 3, false);

                    // Display the final processed image on the canvas
                    cv.imshow('canvasOutput', dst);

                    // Schedule the next frame processing
                    let delay = 1000/FPS - (Date.now() - begin);
                    setTimeout(processVideo, delay);

                } catch (err) {
                    console.error("OpenCV Error: " + err);
                }
            }

            // Start the processing loop
            setTimeout(processVideo, 0);
        }

    </script>
</body>
</html>
